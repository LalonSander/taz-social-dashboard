<%# app/views/posts/index.html.erb - BOOTSTRAP VERSION %>

<div class="d-flex">
  <!-- Sidebar Filters -->
  <aside class="sidebar d-none d-lg-block">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0">Filters</h5>
      <%= link_to "Clear All", posts_path, class: "btn btn-sm btn-outline-secondary" %>
    </div>

    <%= form_with url: posts_path, method: :get, data: { turbo_frame: "posts_table" } do |f| %>
      <!-- Search -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Search Content</label>
        <%= f.text_field :search,
            value: params[:search],
            placeholder: "Search posts...",
            class: "form-control form-control-sm" %>
      </div>

      <!-- Post Type -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Post Type</label>
        <%= f.select :post_type,
            options_for_select([
              ['All Types', 'all'],
              ['Link', 'link'],
              ['Image', 'image'],
              ['Text', 'text'],
              ['Video', 'video']
            ], params[:post_type] || 'all'),
            {},
            class: "form-select form-select-sm" %>
      </div>

      <!-- Date Range -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Date Range</label>
        <div class="mb-2">
          <label class="form-label small text-muted">From</label>
          <%= f.date_field :date_from,
              value: params[:date_from],
              class: "form-control form-control-sm" %>
        </div>
        <div>
          <label class="form-label small text-muted">To</label>
          <%= f.date_field :date_to,
              value: params[:date_to],
              class: "form-control form-control-sm" %>
        </div>
      </div>

      <!-- Minimum Interactions -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Min. Interactions</label>
        <%= f.number_field :min_interactions,
            value: params[:min_interactions],
            placeholder: "e.g. 100",
            min: 0,
            class: "form-control form-control-sm" %>
        <small class="form-text text-muted">Total likes + replies + reposts</small>
      </div>

      <!-- Minimum Performance -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Min. Performance Score</label>
        <%= f.number_field :min_performance,
            value: params[:min_performance],
            placeholder: "e.g. 150",
            min: 0,
            class: "form-control form-control-sm" %>
        <small class="form-text text-muted">Percentage vs baseline (100% = average)</small>
      </div>

      <!-- Preserve sort parameters -->
      <%= f.hidden_field :sort, value: params[:sort] %>
      <%= f.hidden_field :direction, value: params[:direction] %>

      <!-- Apply Button -->
      <%= f.submit "Apply Filters", class: "btn btn-primary btn-sm w-100" %>
    <% end %>
  </aside>

  <!-- Main Content Area -->
  <div class="main-content flex-grow-1">
    <!-- Mobile Filter Toggle -->
    <div class="d-lg-none bg-white border-bottom p-3">
      <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas">
        <i class="bi bi-funnel me-2"></i>
        Filters
      </button>
    </div>

    <!-- Table Container -->
    <%= turbo_frame_tag "posts_table" do %>
      <div class="table-container">
        <table class="table table-hover mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'posted_at', direction: (params[:sort] == 'posted_at' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Date
                  <% if params[:sort] == 'posted_at' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
              <th scope="col">Content</th>
              <th scope="col" class="text-nowrap">Type</th>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'likes', direction: (params[:sort] == 'likes' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Likes
                  <% if params[:sort] == 'likes' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'replies', direction: (params[:sort] == 'replies' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Replies
                  <% if params[:sort] == 'replies' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'reposts', direction: (params[:sort] == 'reposts' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Reposts
                  <% if params[:sort] == 'reposts' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'total_interactions', direction: (params[:sort] == 'total_interactions' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Total
                  <% if params[:sort] == 'total_interactions' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
              <th scope="col" class="text-nowrap">Trend</th>
              <th scope="col" class="text-nowrap">
                <%= link_to posts_path(sort: 'overperformance', direction: (params[:sort] == 'overperformance' && params[:direction] == 'desc') ? 'asc' : 'desc', search: params[:search], post_type: params[:post_type], date_from: params[:date_from], date_to: params[:date_to], min_interactions: params[:min_interactions], min_performance: params[:min_performance]), class: "text-decoration-none text-dark d-flex align-items-center gap-1", data: { turbo_frame: "posts_table" } do %>
                  Performance
                  <% if params[:sort] == 'overperformance' %>
                    <i class="bi bi-caret-<%= params[:direction] == 'asc' ? 'up' : 'down' %>-fill small"></i>
                  <% end %>
                <% end %>
              </th>
            </tr>
          </thead>
          <tbody>
            <% if @posts.any? %>
              <% @posts.each do |post| %>
                <tr>
                  <td class="text-nowrap">
                    <% if post.platform_url %>
                      <%= link_to post.platform_url, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none" do %>
                        <div class="fw-medium"><%= post.posted_at.strftime('%b %d') %></div>
                        <small class="text-muted"><%= post.posted_at.strftime('%H:%M') %></small>
                      <% end %>
                    <% else %>
                      <div class="fw-medium"><%= post.posted_at.strftime('%b %d') %></div>
                      <small class="text-muted"><%= post.posted_at.strftime('%H:%M') %></small>
                    <% end %>
                  </td>
                  <td style="max-width: 400px;">
                    <div class="text-truncate" style="max-width: 400px;">
                      <%= post.truncated_content(120) %>
                    </div>
                    <% if post.external_url %>
                      <%= link_to post.external_url, target: "_blank", class: "small text-decoration-none" do %>
                        <i class="bi bi-box-arrow-up-right me-1"></i>
                        <%= URI.parse(post.external_url).host %>
                      <% end %>
                    <% end %>
                  </td>
                  <td class="text-nowrap">
                    <span class="badge <%= case post.post_type
                          when 'link' then 'bg-primary'
                          when 'image' then 'bg-secondary'
                          when 'video' then 'bg-danger'
                          else 'bg-light text-dark'
                          end %>">
                      <%= post.post_type.capitalize %>
                    </span>
                  </td>
                  <td class="fw-semibold"><%= number_with_delimiter(post.latest_metrics&.likes || 0) %></td>
                  <td class="fw-semibold"><%= number_with_delimiter(post.latest_metrics&.replies || 0) %></td>
                  <td class="fw-semibold"><%= number_with_delimiter(post.latest_metrics&.reposts || 0) %></td>
                  <td class="fw-bold"><%= number_with_delimiter(post.latest_total_interactions) %></td>
                  <td>
                    <%= post_metrics_sparkline(post, width: 80, height: 25) %>
                  </td>
                  <td class="text-nowrap">
                    <% if post.overperformance_score_cache.present? %>
                      <% score = post.overperformance_score_cache %>
                      <span class="badge <%= if score >= 150
                                'bg-success'
                              elsif score >= 100
                                'bg-primary'
                              elsif score >= 50
                                'bg-warning text-dark'
                              else
                                'bg-danger'
                              end %>">
                        <%= number_with_precision(score, precision: 1) %>%
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="9" class="text-center py-5">
                  <i class="bi bi-inbox display-4 text-muted"></i>
                  <p class="mt-3 mb-1 fw-medium">No posts found</p>
                  <p class="text-muted small">Try adjusting your filters or sync your accounts</p>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @posts.any? %>
        <div class="bg-white border-top p-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="text-muted small">
              Showing
              <span class="fw-semibold"><%= @posts.offset_value + 1 %></span>
              to
              <span class="fw-semibold"><%= [@posts.offset_value + @posts.length, @posts.total_count].min %></span>
              of
              <span class="fw-semibold"><%= @posts.total_count %></span>
              posts
            </div>

            <nav>
              <%= paginate @posts,
                  params: {
                    search: params[:search],
                    post_type: params[:post_type],
                    date_from: params[:date_from],
                    date_to: params[:date_to],
                    min_interactions: params[:min_interactions],
                    min_performance: params[:min_performance],
                    sort: params[:sort],
                    direction: params[:direction]
                  },
                  theme: 'custom' %>
            </nav>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Mobile Filters Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filtersOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filters</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <!-- Same filter form as sidebar -->
    <%= form_with url: posts_path, method: :get do |f| %>
      <!-- Filters content (same as sidebar) -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Search Content</label>
        <%= f.text_field :search, value: params[:search], placeholder: "Search posts...", class: "form-control form-control-sm" %>
      </div>
      <%= f.submit "Apply Filters", class: "btn btn-primary w-100" %>
    <% end %>
  </div>
</div>
